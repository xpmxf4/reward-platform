# ??? / ?? ?? ??? ?? (?????? PC ??? ??)

? ????? ?????? PC ??? ???? ??? "??? / ?? ?? ???"? ???? ?? ??? ???. ??????? ????(MSA)? ???? Gateway, Auth Server, Event Server ?? ??? API ??? ???? ??????, ?? ???? ????? ???, ??? ??? ? ?? ???? ?? ?? ???? ??????.

## ?? ?? ??

-   Node.js 18
-   NestJS (?? ??)
-   MongoDB
-   TypeScript
-   Docker, Docker Compose
-   JWT (JSON Web Token) ?? ??

## ?? ??

1.  ???? ?? ?????? ?? ???? ???? ?? ???? ???? ?????. (?? ?? ? ?? ???? ?? ? `--build` ?? ??)
    ```bash
    docker-compose up --build -d
    ```
2.  ??? ?? ? ????/???? ??? ?? ???? ?????.
    ```bash
    docker-compose down
    ```
3.  (??) ??? ???? ??? ????? ?? ???? ?????. (??: MongoDB ???? ?????.)
    ```bash
    docker-compose down -v
    ```

### ??? ?? ??

-   **Gateway Server:** `http://localhost:3000` (????? ?? ???)
-   **Auth Server:** ?? ??? (Docker ???? ? `http://auth-server:3001`, ?? ??? `docker-compose.yml` ??? ??)
-   **Event Server:** ?? ??? (Docker ???? ? `http://event-server:3002`, ?? ??? `docker-compose.yml` ??? ??)
-   **MongoDB:** `mongodb://localhost:27017` (????? ?? ?? ?, DB ??? `auth_db`, `event_db`)

## ?? ??

? ????? ?? ?? ??? `docs` ?? ? ? ??? ?????? ????.

-   **[0. ?? ??](./docs/00_Assignment_Analysis.md):** ?? ???? ?? ? ?? ??
-   **[1. ??? ????](./docs/01_System_Architecture.md):** ?? ?? API ?? ???? ? ?? Kafka ??? ??? ?? ????
-   **[2. ??? ??](./docs/02_Data_Model.md):** MongoDB ??? ??? ?? (User, Event, Reward, UserRewardRequest)
-   **[3. API ????? ??](./docs/03_API_Endpoints.md):** Gateway ?? ?? API ??
-   **[4. Saga ?? ? ??? ??](./docs/04_Saga_And_Idempotency.md):** ??? ?? ?? ?? Saga, ???, ?? ??? ? Kafka ?? ?? ?? ?? (? ??? ?? ??)

## ?? ?? ?? ??

? ????? "?? ?????? ? ??? ??? ???"?? ??? ?? ??????? ??, ??? ?? ?? ?? ??? ??? ???? ???? ???? ????? ??????.

### 1. ??????? ???? (MSA) ??

-   **Gateway, Auth Server, Event Server**? ???? ???? ? ???? ??? ??? ??? ????. ([??: ??? ????](./docs/01_System_Architecture.md))
-   ?? ?? ??? ???? ??, ??, ??? ????, ? ???? ??? ?? ???? ??? ??? ???? ? ?? ??? ??????.

### 2. ??? ?? ?? ?? - Saga ?? (Orchestration) ??

-   ?? ???? ?? ??? ?? ?????? ???? "??? ?? ??" ??? ??? ???? ???? ?? **Saga ??(Orchestration ??)**? ??????.
-   **Event Server? `EventClaimsService`? Orchestrator ??**? ????, ??? ?? ??? ????? ???? ? ??? ??/??? `UserRewardRequest` ??? ?????.
   1.  **S0: ?? ?? ? ???:** ??? ? ??, `UserRewardRequest` ?? ?? (`PENDING_VALIDATION` ??).
   2.  **S1: ??? ? ??? ??? ??:** Auth Server? ?? ??? ?? ??(Mock), Event DB?? ??? ??/??/???? ??.
   3.  **S2: ??? ?? ?? ??:** Game Data Service(Mock)? ?? ?? ?? ?? ??.
   4.  **S3: ?? ?? ?? ? ??:** ?? ?? ??? ?? Event DB?? ?? ??? ?? (???? ??).
   5.  **S4: ?? ?? ??:** Reward Fulfillment Service(Mock)? ?? ?? ?? ??.
   6.  **S5: ?? ??:** Saga ?? ?? ??(?? ??) ?? ??.
-   **??(?? ????):** ? ?? ?? ?, `EventClaimsService`? ?? ??? ?? ??? ??? ???? ?? ????(?: `compensateInventory`)? ???? ??? ???? ?????.
-   **?? ??:** [Saga ?? ? ??? ?? ??](./docs/04_Saga_And_Idempotency.md)? "2. ??? ?? ?? ?? Saga" ???? ?? ???, ?? ?? ?????, ? ??? ?? ?? ? ?? ????? ?? ???? ??? ??? ? ????.

### 3. API ???(Idempotency) ??

-   ??? ??? ???? ?? API, ?? `POST /api/event-claims/{eventId}/claim` (??? ?? ??)? ?? **`X-Idempotency-Key` HTTP ??**? ???? ???? ?????.
-   ?????? ?? ?? ? ??? ??? ?? ???? ????, ???? ?? ??? ??? ? ??? ?? ?????.
-   ??(`EventClaimsService.initiateClaim`)? ??? ??? ?? `UserRewardRequest`? `requestId`? ????, ?? `requestId`? ??? ?? ??????(??/??) ?? ?? ??? ???? ?? ??? ???? ??? ??? ?????.
-   **?? ??:** [Saga ?? ? ??? ?? ??](./docs/04_Saga_And_Idempotency.md)? "3. API ??? ?? ??" ?? ??.

### 4. ?? ?? ???(Edge Case) ?? ? ??

-   ??? ?? ?? Saga ?? ? ??? ? ?? ??? ?? ???(?: ??? ??/?, ??? ???/??, ?? ?? ?? ?? ??, ?? ???(Mock) ??/????, ?? ??? ?? ???, DB ??, ?? ???? ?? ?? ?)? ????, ? ??? ?? ?? ?? ? `UserRewardRequest`? ?? ??? ??????.
-   **?? ??:** [Saga ?? ? ??? ?? ??](./docs/04_Saga_And_Idempotency.md)? "4. ?? ?? ??? ? ?? ?? (?)" ??.

### 5. ?? ?? ?? ? ?? ?? ??

-   **?? ??:** ?? ?? ??? ?? ??? `EventClaimsService`?? MongoDB? ??? ???? (`updateOne`? `$inc` ???)? ???? **???? ??**?? ???????. ?? ?? ??? ?? ???? ?????, ?? ?? ??? ????? ??? ????? ?? ??? ?? ??? ???? ?????.
-   **?? ?? ?? (?? ? ??):** ? ???? ???? ???, ?? ???? ????? ?? ??? ??? ??? ?? **Redis ?? ??? ?? ?(Distributed Lock)** ????? Saga? S3(?? ??) ??? ??? ?? ?????. `rewardId`?? ?? ??? ? ??? ???? ??/??????, ?? ?? ???? ????? ??? ???? ?? ???? ??? ? ????.

### 6. ??? ?? - Kafka ??? ?? ???? ?? ?? (?? ?? ??)

? ??? ?? ?? ? ??? "???? ?? ???? ?? ??" ? ???? ???? ??? ??? ??, ??? ??? API ?? ????? ???? ???? **Apache Kafka? ?? ??? ?? ???? ??? ?? ????(EDA)? ???? ??? ?? ?? ??**????.

-   **?? ??? Saga? ???:**
   * `EventClaimsService`? ??? **??(?? ????) ??? ???** ("??? ???? ? ???? ??").
   * ?? ??? ??? ?? **??? ? ?? ??** ? ?? ??? ??/?? ? **?? Saga ??/??? ??**.
   * **? ????**?? ?? ??? ?? ?? ??.
   * ([??: Saga ?? ?? - 2.5?](./docs/04_Saga_And_Idempotency.md#25-??-????-api-??-orchestration-saga?-???-?-???))

-   **Kafka ??? ?? ?? ?? ? ?? ????:**
   1.  **(??) Game Server ? Event Server (??? ?? ??? ??):** ?? ? ???? ??? ??? ??(??? ??, ??? ?)? Kafka ???? ????, Event Server? ?? ?????? ???? ??? ?? ?? ??? ?????. ?? ?? ??? API ?? ??? ???? ??? ? ???? ?? ? ????.
   2.  **Auth Server ? Event Server (??? ?? ?? ??):** ??? ??/? ?? ?? ?? ???? Kafka? ????, Event Server? ?? ???? ?? ?? ?? ?? Saga? ???? ????? ?? ??? ?????? ??? ? ????.
   3.  **??? ?? ?? Saga? ???? (Orchestration + Event ????? ??):**
      * `EventClaimsService`(Orchestrator)? Saga? ? ?? ??? ?? ?? ???? ??, ?? ??? ???? **???(Command)? ???? Kafka? ??**???.
      * ? ???? ???? ?? ???(Event Server ? ?? ?? ?? ?? ???)? ?? ?? ? ? ??? **??(Result) ???? Kafka? ?? ??**???.
      * Orchestrator? ? ?? ???? ???? ?? ??? ?????, ?? ? **?? ??? ???? Kafka? ??**?? ? ???? ??? ?? ??? ?????? ????? ???.
      * ?? ?? API ?? ?? ??? ????, ??? ? ???? ???, "??? ????" ?? ??? ???? ? ?? ???? ???? ? ????.
   * **?? Kafka ?? ???? ? ??? ???? ??:** [Saga ?? ?? - 2.6?](./docs/04_Saga_And_Idempotency.md#26-??-??-??-apache-kafka-???-??-saga-??-??) ? [??? ???? ?? - C?](./docs/01_System_Architecture.md#c-??-????-???-????-kafka-??-????) ??.

??? Kafka ?? ??? ?? ???? ??? ??? ????, ? ?? ????? ????? ?? ??? ?????.

### 7. ??? ?? ? Mock ??

-   **?? ?? ?? ??:**
   * Auth Server: ??? ??, ???(JWT ??), ??? ?? API.
   * Event Server: ??? CRUD API, ??? ?? ?? ?? Saga ????? (`EventClaimsService` - ?? ??, ?? ??/?? ??, ?? ?? ?? ? ?? ?? ??), ??? ?? ?? ?? ?? ?? API.
   * Gateway Server: Auth Server ? Event Server ?? API? ?? ??? ? JWT ?? ?? ???.
-   **Mock ??? ??:**
   * `EventClaimsService` ?? ?? ??? ??(Auth Server ??? ?? ?? ??, Game Data Service ?? ??? ??, Reward Fulfillment Service ?? ?? ??)? ?? Mock ????? ? ??? Mock ???? ???? Saga? ???? ??? ?? ??, ?? ??? ??? ??????.
-   **?? ???? ?? ???/??? ??:**
   * ???/???? ?? ?? API (????/???? ?? ?? ?? ??? ?)? ?? ??? ??.
   * ??? ?? ?? ??? ?? ?? ?? ???? DB ???? ?? (?, ??? ? ?? ?? ??).
   * Kafka ??? ???? ??.
   * ?? ??? ? E2E ??? ?? ??? ?? ???? ?? (?? ???? ?? ??).